<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>使用 Kubeadm 部署 Kubernetes 集群（基于 Containerd 运行时） | 小下同学</title><meta name="author" content="安小下同学"><meta name="copyright" content="安小下同学"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kubeadm 安装 Kubernetes V1.22.2 踩坑手记，使用 Docker 作 Container Runtime">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Kubeadm 部署 Kubernetes 集群（基于 Containerd 运行时）">
<meta property="og:url" content="https://blog.linganmin.cn/posts/c62b22dc/index.html">
<meta property="og:site_name" content="小下同学">
<meta property="og:description" content="Kubeadm 安装 Kubernetes V1.22.2 踩坑手记，使用 Docker 作 Container Runtime">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://graph.linganmin.cn/230201/236bd147e42b9a2fcd31784975f76399?x-oss-process=image/format,webp/quality,q_10">
<meta property="article:published_time" content="2023-02-01T06:32:12.228Z">
<meta property="article:modified_time" content="2023-05-02T03:41:58.020Z">
<meta property="article:author" content="安小下同学">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Kubeadm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://graph.linganmin.cn/230201/236bd147e42b9a2fcd31784975f76399?x-oss-process=image/format,webp/quality,q_10"><link rel="shortcut icon" href="https://graph.linganmin.cn/201206/fe9c5e8ef76354659ab9c6c8764d6f3d"><link rel="canonical" href="https://blog.linganmin.cn/posts/c62b22dc/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="KrvBZb2kkH"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b4e74da1cb3c8b4a65da55116b8cba6f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '使用 Kubeadm 部署 Kubernetes 集群（基于 Containerd 运行时）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-02 11:41:58'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://graph.linganmin.cn/200118/06177d8b92c66f2c3a6fd82cca544f51" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://graph.linganmin.cn/230201/236bd147e42b9a2fcd31784975f76399?x-oss-process=image/format,webp/quality,q_60')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小下同学</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">使用 Kubeadm 部署 Kubernetes 集群（基于 Containerd 运行时）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-01T06:32:12.228Z" title="发表于 2023-02-01 14:32:12">2023-02-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-02T03:41:58.020Z" title="更新于 2023-05-02 11:41:58">2023-05-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="使用 Kubeadm 部署 Kubernetes 集群（基于 Containerd 运行时）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="CRI、Containerd、OCI、runc"><a href="#CRI、Containerd、OCI、runc" class="headerlink" title="CRI、Containerd、OCI、runc"></a>CRI、Containerd、OCI、runc</h3><h4 id="CRI"><a href="#CRI" class="headerlink" title="CRI"></a>CRI</h4><p>CRI(Container Runtime Interface)是<code>Kubernetes</code>定义的接口，定义了如何操作容器和镜像的统一规范。Kubernetes 尽量不关心您使用哪个容器运行时。 它只需要能够向它发送指令——为<code>Pod</code>创建容器、终止它们等等。 这就是<code>CRI</code>的用武之地。<code>CRI</code> 是对现在或将来可能存在的任何类型的容器运行时的抽象。 所以 <code>CRI</code> 让 Kubernetes 更容易使用不同的容器运行时。 <code>CRI</code> API描述了<code>Kubernetes</code>如何与任何运行时交互，而不是<code>Kubernetes</code>项目需要单独添加对每个运行时的支持。 只要给定的容器运行时实现了<code>CRI</code> API，运行时就可以随心所欲地创建和启动容器。</p>
<p><img src="https://graph.linganmin.cn/230201/ea90a93e75b45ff4dde97f1a4d96fdca?x-oss-process=image/format,webp/quality,q_60" alt="You can choose your own container runtime for Kubernetes"></p>
<h4 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h4><p><code>containerd</code>是一个来自<code>Docker</code>的高级容器运行时，并实现了<code>CRI</code>规范。它是从<code>Docker</code>项目中分离出来，之后<code>containerd</code>被捐赠给云原生计算基金会（CNCF）为容器社区提供创建新容器解决方案的基础。</p>
<p>所以<code>Docker</code>自己在内部使用<code>containerd</code>，当你安装<code>Docker</code>时也会安装<code>containerd</code>.</p>
<p><code>containerd</code>通过其<code>CRI</code>插件实现了<code>Kubernetes</code>容器运行时接口（<code>CRI</code>），它可以管理容器的整个生命周期，包括从镜像的传输、存储到容器的执行、监控再到网络。</p>
<h4 id="OCI"><a href="#OCI" class="headerlink" title="OCI"></a>OCI</h4><p>Open Container Initiative 是一个开放的治理结构，其明确目的是围绕容器格式和运行时创建开放的行业标准</p>
<h4 id="Runc"><a href="#Runc" class="headerlink" title="Runc"></a>Runc</h4><p>runc 是一个兼容<code>OCI</code>标准的容器运行时。它实现<code>OCI</code>规范并运行容器进程。<br>runc 为容器提供所有低级功能，与现有的低级<code>Linux</code>功能（如<code>namespaces</code>和<code>control groups</code>）交互。它使用这些功能来创建和运行容器进程。</p>
<p><img src="https://graph.linganmin.cn/230201/e886b156ff4803fc27a44b382ee0fb1d?x-oss-process=image/format,webp/quality,q_60" alt="The relationship between Docker, CRI-O, containerd and runc – in a nutshell"></p>
<h3 id="ipvs"><a href="#ipvs" class="headerlink" title="ipvs"></a>ipvs</h3><p>todo</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h3><ul>
<li>系统版本<ul>
<li>CentOS7.9</li>
<li>Linux 内核<ul>
<li>3.10.0-1160.el7.x86_64</li>
</ul>
</li>
</ul>
</li>
<li>Master 节点<ul>
<li>172.16.168.135</li>
<li>2C&#x2F;4G</li>
</ul>
</li>
<li>Node 节点<ul>
<li>172.16.168.136</li>
<li>2C&#x2F;4G</li>
</ul>
</li>
</ul>
<h3 id="软件版本"><a href="#软件版本" class="headerlink" title="软件版本"></a>软件版本</h3><ul>
<li>Kubernetes<ul>
<li>1.25.3</li>
</ul>
</li>
<li>Containerd<ul>
<li>1.6.16</li>
</ul>
</li>
</ul>
<h3 id="网段划分"><a href="#网段划分" class="headerlink" title="网段划分"></a>网段划分</h3><p>参考另一篇关于网段划分的文章：<a href="https://blog.linganmin.cn/posts/4f614365/">Kubernetes 集群部署之网段划分</a></p>
<ul>
<li>宿主机 CIDR<ul>
<li>172.16.168.0&#x2F;24</li>
</ul>
</li>
<li>Kubernetes Service CIDR<ul>
<li>10.96.0.0&#x2F;12<ul>
<li>10.96.0.1 ~ 10.111.255.254</li>
</ul>
</li>
</ul>
</li>
<li>Kubernetes POD CIDR<ul>
<li>10.16.0.0&#x2F;12<ul>
<li>10.16.0.1 ~ 10.31.255.254</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="初始化基础环境"><a href="#初始化基础环境" class="headerlink" title="初始化基础环境"></a>初始化基础环境</h3><blockquote>
<p>除<code>修改hostname</code>在各自节点执行，其余步骤均需在所有节点执行！！！</p>
</blockquote>
<h4 id="修改hostname"><a href="#修改hostname" class="headerlink" title="修改hostname"></a>修改hostname</h4><p>此步骤在各自节点执行！！！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname master</span><br><span class="line"></span><br><span class="line">hostnamectl set-hostname node1</span><br></pre></td></tr></table></figure>

<h4 id="yum-update"><a href="#yum-update" class="headerlink" title="yum update"></a>yum update</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum update</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="修改hosts文件，使机器可以使用hostname互通"><a href="#修改hosts文件，使机器可以使用hostname互通" class="headerlink" title="修改hosts文件，使机器可以使用hostname互通"></a>修改hosts文件，使机器可以使用hostname互通</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">172.16.168.135   master</span></span><br><span class="line"><span class="string">172.16.168.136   node1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld &amp;&amp; systemctl status firewalld</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="关闭-selinux"><a href="#关闭-selinux" class="headerlink" title="关闭 selinux"></a>关闭 selinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="关闭-swap"><a href="#关闭-swap" class="headerlink" title="关闭 swap"></a>关闭 swap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/swap/s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置-iptables-的-ACCEPT-规则"><a href="#配置-iptables-的-ACCEPT-规则" class="headerlink" title="配置 iptables 的 ACCEPT 规则"></a>配置 iptables 的 ACCEPT 规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="转发-IPv4-并让-iptables-看到桥接流量"><a href="#转发-IPv4-并让-iptables-看到桥接流量" class="headerlink" title="转发 IPv4 并让 iptables 看到桥接流量"></a>转发 IPv4 并让 iptables 看到桥接流量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置所需的 sysctl 参数，参数在重新启动后保持不变</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 sysctl 参数而不重新启动</span></span><br><span class="line">sudo sysctl --system</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过运行以下指令确认 br_netfilter 和 overlay 模块被加载</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line">lsmod | grep overlay</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过运行以下指令确认 net.bridge.bridge-nf-call-iptables、net.bridge.bridge-nf-call-ip6tables 和 net.ipv4.ip_forward 系统变量在你的 sysctl 配置中被设置为 1：</span></span><br><span class="line"></span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="安装-ipvs"><a href="#安装-ipvs" class="headerlink" title="安装 ipvs"></a>安装 ipvs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 755 /etc/sysconfig/modules/ipvs.modules </span><br><span class="line"></span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules </span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面脚本创建了的/etc/sysconfig/modules/ipvs.modules 文件，保证在节点重启后能自动加载所需模块。 使用 lsmod | grep -e ip_vs -e nf_conntrack_ipv4 命令查看是否已经正确加载所需的内核模块。 </span></span><br><span class="line"></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>

<h4 id="安装-ipset-amp-ipvsadm"><a href="#安装-ipset-amp-ipvsadm" class="headerlink" title="安装 ipset &amp; ipvsadm"></a>安装 ipset &amp; ipvsadm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum install ipset -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了便于查看 ipvs 的代理规则，最好安装一下管理工具 ipvsadm</span></span><br><span class="line">yum install ipvsadm -y</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="同步服务器时间"><a href="#同步服务器时间" class="headerlink" title="同步服务器时间"></a>同步服务器时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum install chrony -y</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line">systemctl start chronyd</span><br><span class="line">chronyc sources</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装-containerd"><a href="#安装-containerd" class="headerlink" title="安装 containerd"></a>安装 containerd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum install -y yum-utils</span><br><span class="line"></span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum install -y containerd.io</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="创建-containerd-配置文件"><a href="#创建-containerd-配置文件" class="headerlink" title="创建 containerd 配置文件"></a>创建 containerd 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># 替换配置文件的国内镜像</span></span><br><span class="line">sed -i <span class="string">&#x27;s#sandbox_image = &quot;registry.k8s.io/pause:3.6&quot;#sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.6&quot;#&#x27;</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于使用<code>systemd</code>作为<code>init system</code>的<code>Linux</code>发行版，使用<code>systemd</code>作为容器的<code>cgroup driver</code>可以确保节点在资源紧张的情况更加稳定，所以推荐将<code>containerd</code>的<code>cgroup driver</code>配置为<code>systemd</code>。[官网文档](<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#cgroup-drivers%EF%BC%89">https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#cgroup-drivers）</a></p>
</blockquote>
<p>修改前面生成的配置文件<code>/etc/containerd/config.toml</code>，在<code>plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options</code>配置块下面将<code>SystemdCgroup</code>设置为<code>true</code>，并且<code>kubelet</code>的<code>cgroupDriver</code>也要使用<code>systemd</code>以保持一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s#SystemdCgroup = false#SystemdCgroup = true#&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="启动-containerd"><a href="#启动-containerd" class="headerlink" title="启动 containerd"></a>启动 containerd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> containerd</span><br><span class="line">systemctl start containerd</span><br><span class="line">systemctl status containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">ctr version</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装三大件"><a href="#安装三大件" class="headerlink" title="安装三大件"></a>安装三大件</h3><h4 id="Kubernetes-repo"><a href="#Kubernetes-repo" class="headerlink" title="Kubernetes repo"></a>Kubernetes repo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class="line"><span class="string">http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="安装-kubeadm、kubelet、kubectl（我安装的指定版本-1-25-3，有版本要求自己设定版本）"><a href="#安装-kubeadm、kubelet、kubectl（我安装的指定版本-1-25-3，有版本要求自己设定版本）" class="headerlink" title="安装 kubeadm、kubelet、kubectl（我安装的指定版本 1.25.3，有版本要求自己设定版本）"></a>安装 kubeadm、kubelet、kubectl（我安装的指定版本 1.25.3，有版本要求自己设定版本）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum install -y kubelet-1.25.3 kubeadm-1.25.3 kubectl-1.25.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="设置运行时"><a href="#设置运行时" class="headerlink" title="设置运行时"></a>设置运行时</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">crictl config runtime-endpoint /run/containerd/containerd.sock</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置-kubelet-的-cgroup"><a href="#配置-kubelet-的-cgroup" class="headerlink" title="配置 kubelet 的 cgroup"></a>配置 kubelet 的 cgroup</h4><p><code>kubeadm</code>支持在执行<code>kubeadm init</code>时，传递一个<code>KubeletConfiguration</code>结构体。<code>KubeletConfiguration</code>包含<code>cgroupDriver</code>字段，可用于控制<code>kubelet</code>的<code>cgroup</code>驱动。</p>
<p><em><strong>在<code>kubeadm</code>1.22版本后，如果没有在<code>KubeletConfiguration</code>中设置<code>cgroupDriver</code>，<code>kubeadm</code>会将其默认设置为<code>systemd</code></strong></em></p>
<p>下面是一个最小化示例，显式的配置了此字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">systemd</span></span><br></pre></td></tr></table></figure>

<p>因为我们使用<code>kubeadm</code>版本较高，所以不用在<code>kubeadm config print init-defaults &gt; kubeadm.yaml</code>生成的声明文件中配置此项。</p>
<h4 id="将-kubelet-设置成开机启动"><a href="#将-kubelet-设置成开机启动" class="headerlink" title="将 kubelet 设置成开机启动"></a>将 kubelet 设置成开机启动</h4><blockquote>
<p>此时如果启动<code>kubelet</code>将会失败，因为<code>kube-apiserver</code>还没有启动，<code>kubelet</code>无法建立连接。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="初始化集群-Master-节点"><a href="#初始化集群-Master-节点" class="headerlink" title="初始化集群 Master 节点"></a>初始化集群 Master 节点</h2><p>通过如下命令导出默认的初始化配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>以下仅列出修改的点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bootstrapTokens 下修改项</span></span><br><span class="line"><span class="attr">advertiseAddress:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span> <span class="comment"># 修改为自己的 master 节点 IP</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">master</span> <span class="comment"># 修改为 master</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apiServer 下修改项</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="attr">bind-address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment"># Prometheus 采集 metrics 要用</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line">    <span class="attr">extraArgs:</span></span><br><span class="line">      <span class="attr">listen-metrics-urls:</span> <span class="string">http://0.0.0.0:2381</span> <span class="comment"># Prometheus 采集 metrics 要用</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers</span> <span class="comment"># 因为网络问题拉取不到官方镜像，修改为阿里云镜像地址</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.25</span><span class="number">.3</span> <span class="comment">#确认是否为要安装版本，版本根据执行：kubelet --version 得来</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.16</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span> 　<span class="comment">#  下添加 pod 网段，注意该网段不能和主机在同一网段下</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="attr">extraArgs:</span></span><br><span class="line">    <span class="attr">bind-address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment"># Prometheus 采集 metrics 要用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#  添加 proxy 模式使用 ipvs</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">ipvs</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10249</span> <span class="comment"># Prometheus 采集 metrics 要用</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubeadm init --config=kubeadm.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行拷贝 kubeconfig 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p>添加节点（node1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 172.16.168.135:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:b4b8f89f3bf52cee593e3f385902fff5001b8c87ca2212527725d513dbc15ea2 </span><br></pre></td></tr></table></figure>

<p>查看集群状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS     ROLES           AGE    VERSION</span><br><span class="line">master   NotReady   control-plane   6m7s   v1.25.3</span><br><span class="line">node     NotReady   &lt;none&gt;          10s    v1.25.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h2><p> 可以看到是<code>NotReady</code>状态，这是因为还没有安装网络插件，必须部署一个容器网络接口 <code>(CNI)</code> 基于<code>Pod</code>网络附加组件，以便您的<code>Pod</code>可以相互通信。在安装网络之前，集群<code>DNS (CoreDNS)</code> 不会启动，这里我们安装<code>calico</code>，<a target="_blank" rel="noopener" href="https://projectcalico.docs.tigera.io/about/about-calico">calico文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载calico 资源清单文件</span></span><br><span class="line">wget https://projectcalico.docs.tigera.io/archive/v3.25/manifests/calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 POD 运行状态</span></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"><span class="comment"># NAME                                       READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># calico-kube-controllers-74677b4c5f-tg9cm   1/1     Running   0          107s</span></span><br><span class="line"><span class="comment"># calico-node-8z52z                          1/1     Running   0          107s</span></span><br><span class="line"><span class="comment"># calico-node-wk8ww                          1/1     Running   0          107s</span></span><br><span class="line"><span class="comment"># coredns-7f8cbcb969-pnckr                   1/1     Running   0          10m</span></span><br><span class="line"><span class="comment"># coredns-7f8cbcb969-pqhkk                   1/1     Running   0          10m</span></span><br><span class="line"><span class="comment"># etcd-master                                1/1     Running   2          10m</span></span><br><span class="line"><span class="comment"># kube-apiserver-master                      1/1     Running   2          10m</span></span><br><span class="line"><span class="comment"># kube-controller-manager-master             1/1     Running   0          10m</span></span><br><span class="line"><span class="comment"># kube-proxy-7zx75                           1/1     Running   0          9m48s</span></span><br><span class="line"><span class="comment"># kube-proxy-f82rl                           1/1     Running   0          10m</span></span><br><span class="line"><span class="comment"># kube-scheduler-master                      1/1     Running   6          10m</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此<code>Kubernetes</code>安装完成。</p>
<h2 id="部署一个-Deployment-资源"><a href="#部署一个-Deployment-资源" class="headerlink" title="部署一个 Deployment 资源"></a>部署一个 Deployment 资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建一个名叫 nginx 的 deployment pod 副本数为3</span></span><br><span class="line">kubectl create deployment nginx --image=nginx:latest -r=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器状态</span></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment"># NAME                     READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># nginx-6d666844f6-hrlxv   1/1     Running   0          106s</span></span><br><span class="line"><span class="comment"># nginx-6d666844f6-n5tjz   1/1     Running   0          106s</span></span><br><span class="line"><span class="comment"># nginx-6d666844f6-t7865   1/1     Running   0          106s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 deployment</span></span><br><span class="line">kubectl get deploy</span><br><span class="line"><span class="comment"># NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line"><span class="comment"># nginx   3/3     3            3           2m42s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.linganmin.cn">安小下同学</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.linganmin.cn/posts/c62b22dc/">https://blog.linganmin.cn/posts/c62b22dc/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.linganmin.cn" target="_blank">小下同学</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/Kubeadm/">Kubeadm</a></div><div class="post_share"><div class="social-share" data-image="https://graph.linganmin.cn/230201/236bd147e42b9a2fcd31784975f76399?x-oss-process=image/format,webp/quality,q_10" data-sites="twitter,wechat,weibo"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://graph.linganmin.cn/231215/d0d6741198e276c5aac3299725e68e4a?x-oss-process=image/format,webp/quality,q_60" target="_blank"><img class="post-qr-code-img" src="https://graph.linganmin.cn/231215/d0d6741198e276c5aac3299725e68e4a?x-oss-process=image/format,webp/quality,q_60" alt="请我吃苹果"/></a><div class="post-qr-code-desc">请我吃苹果</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/49a0b438/"><img class="prev-cover" src="https://graph.linganmin.cn/230202/45c4be216e488ead47b3373c4a04187f?x-oss-process=image/format,webp/quality,q_10" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux OS 的 Init 和 Systemd</div></div></a></div><div class="next-post pull-right"><a href="/posts/4f614365/"><img class="next-cover" src="https://graph.linganmin.cn/230201/1121c70cca031f2591b48ce72261dedc?x-oss-process=image/format,webp/quality,q_10" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes 集群部署之网段划分</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/e589412a/" title="Kubeadm 安装 Kubernetes V1.22.2 踩坑手记"><img class="cover" src="https://graph.linganmin.cn/210919/4e6c850efdc628e06f037a82d5d7b185?x-oss-process=image/format,webp/quality,q_10" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-20</div><div class="title">Kubeadm 安装 Kubernetes V1.22.2 踩坑手记</div></div></a></div><div><a href="/posts/2f918798/" title="基于 cert-manage 对阿里云域名自动签发 TLS(https) 证书"><img class="cover" src="https://graph.linganmin.cn/231004/bf4bff6c40c7ab4fc47e037b810b58cb?x-oss-process=image/format,webp/quality,q_10" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-04</div><div class="title">基于 cert-manage 对阿里云域名自动签发 TLS(https) 证书</div></div></a></div><div><a href="/posts/6c891c2/" title="Kubernetes 暴力入门(一)"><img class="cover" src="https://graph.linganmin.cn/200118/3c4cf20b664e660235099a4262185023?x-oss-process=image/format,webp/quality,q_10" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-18</div><div class="title">Kubernetes 暴力入门(一)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://graph.linganmin.cn/200118/06177d8b92c66f2c3a6fd82cca544f51" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">安小下同学</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/linganmin" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:saboranmin@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://www.weibo.com/u/1793963601" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">来日方短、道阻且长；好好吃饭，好好睡觉、保重身体、好好生活，开心快乐 ^_^</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CRI%E3%80%81Containerd%E3%80%81OCI%E3%80%81runc"><span class="toc-number">1.1.</span> <span class="toc-text">CRI、Containerd、OCI、runc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CRI"><span class="toc-number">1.1.1.</span> <span class="toc-text">CRI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Containerd"><span class="toc-number">1.1.2.</span> <span class="toc-text">Containerd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OCI"><span class="toc-number">1.1.3.</span> <span class="toc-text">OCI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Runc"><span class="toc-number">1.1.4.</span> <span class="toc-text">Runc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ipvs"><span class="toc-number">1.2.</span> <span class="toc-text">ipvs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%89%88%E6%9C%AC"><span class="toc-number">2.2.</span> <span class="toc-text">软件版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E6%AE%B5%E5%88%92%E5%88%86"><span class="toc-number">2.3.</span> <span class="toc-text">网段划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="toc-number">2.4.</span> <span class="toc-text">初始化基础环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9hostname"><span class="toc-number">2.4.1.</span> <span class="toc-text">修改hostname</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yum-update"><span class="toc-number">2.4.2.</span> <span class="toc-text">yum update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9hosts%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BD%BF%E6%9C%BA%E5%99%A8%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8hostname%E4%BA%92%E9%80%9A"><span class="toc-number">2.4.3.</span> <span class="toc-text">修改hosts文件，使机器可以使用hostname互通</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">2.4.4.</span> <span class="toc-text">关闭防火墙</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-selinux"><span class="toc-number">2.4.5.</span> <span class="toc-text">关闭 selinux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-swap"><span class="toc-number">2.4.6.</span> <span class="toc-text">关闭 swap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-iptables-%E7%9A%84-ACCEPT-%E8%A7%84%E5%88%99"><span class="toc-number">2.4.7.</span> <span class="toc-text">配置 iptables 的 ACCEPT 规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E5%8F%91-IPv4-%E5%B9%B6%E8%AE%A9-iptables-%E7%9C%8B%E5%88%B0%E6%A1%A5%E6%8E%A5%E6%B5%81%E9%87%8F"><span class="toc-number">2.4.8.</span> <span class="toc-text">转发 IPv4 并让 iptables 看到桥接流量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ipvs"><span class="toc-number">2.4.9.</span> <span class="toc-text">安装 ipvs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ipset-amp-ipvsadm"><span class="toc-number">2.4.10.</span> <span class="toc-text">安装 ipset &amp; ipvsadm</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%B6%E9%97%B4"><span class="toc-number">2.5.</span> <span class="toc-text">同步服务器时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-containerd"><span class="toc-number">2.6.</span> <span class="toc-text">安装 containerd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-containerd-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.6.1.</span> <span class="toc-text">创建 containerd 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-containerd"><span class="toc-number">2.6.2.</span> <span class="toc-text">启动 containerd</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%89%E5%A4%A7%E4%BB%B6"><span class="toc-number">2.7.</span> <span class="toc-text">安装三大件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-repo"><span class="toc-number">2.7.1.</span> <span class="toc-text">Kubernetes repo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-kubeadm%E3%80%81kubelet%E3%80%81kubectl%EF%BC%88%E6%88%91%E5%AE%89%E8%A3%85%E7%9A%84%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC-1-25-3%EF%BC%8C%E6%9C%89%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82%E8%87%AA%E5%B7%B1%E8%AE%BE%E5%AE%9A%E7%89%88%E6%9C%AC%EF%BC%89"><span class="toc-number">2.7.2.</span> <span class="toc-text">安装 kubeadm、kubelet、kubectl（我安装的指定版本 1.25.3，有版本要求自己设定版本）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="toc-number">2.7.3.</span> <span class="toc-text">设置运行时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-kubelet-%E7%9A%84-cgroup"><span class="toc-number">2.7.4.</span> <span class="toc-text">配置 kubelet 的 cgroup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-kubelet-%E8%AE%BE%E7%BD%AE%E6%88%90%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">2.7.5.</span> <span class="toc-text">将 kubelet 设置成开机启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4-Master-%E8%8A%82%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">初始化集群 Master 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-number">3.2.</span> <span class="toc-text">初始化集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">安装网络插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AA-Deployment-%E8%B5%84%E6%BA%90"><span class="toc-number">5.</span> <span class="toc-text">部署一个 Deployment 资源</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2023 By 安小下同学</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/"><img style="height:10px" src="https://img.alicdn.com/imgextra/i3/O1CN012VJ8YA22JOP4XNnCr_!!6000000007099-2-tps-20-20.png">苏ICP备16006718号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/medium-zoom/dist/medium-zoom.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4XeGSIKrWdlKmftMDDFy8fRj-gzGzoHsz',
      appKey: 'Wjn8s1j6JAg3BbYxTNW3nMk9',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('/pluginsSrc/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>